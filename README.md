# Описание на задачата: Импорт на сгради в България от GeoJSONL файлове

## Контекст
Този проект има за цел да внесе в нашата СУБД геометрии за сгради в България, предоставени във формат GeoJSONL, в пространствена база данни PostgreSQL/PostGIS. Данните са изтеглени от глобален публичен източник и са организирани по квадрати (quadkey) за територията на България. Интересува ни територията на София.

## Основни стъпки

1. **Създаване на таблица**: Създава се таблица `bulgaria_buildings` с геометрия (Polygon, EPSG:7801) и указател (индекс) за по-бързо пространствено търсене.
2. **Използване на административни граници**: Използва се `adm_rayoni`, която съдържа административни райони. Полезни данни за подбора на пространствени данни, отнасящи се само за сгради в София.
3. **Внос на данни**: Програмата `import_sofia_buildings.py`:
   - Чете ред по ред GeoJSONL файловете от папка `IN/`. Те са компресирани, за това ги разкомпресира в движение с модула gzip.
   - За всяка сграда проверява дали попада в границите на София 
        1) чрез обвиващия я правоъгълник 
        2) пространствена функция по границите на адм.райони.
   - Вмъква валидните сгради в базата данни.

## Източник на данните

Данните за сгради се изтеглят от проекта на Microsoft [Global ML Building Footprints](https://github.com/microsoft/GlobalMLBuildingFootprints). Връзките за изтегляне са достъпни на:

https://minedbuildings.z5.web.core.windows.net/global-buildings/dataset-links.csv

Списъкът с файлове за България се поддържа в `input.txt` и се изтеглят автоматично в папка `IN/`.

За автоматично изтегляне и обновяване на списъка с файлове използвайте един от следните скриптове:
- `download_sofia_buildings.py` (платформено-независим, изисква Python и requests)
- `download_sofia_buildings.ps1` (PowerShell, работи на Windows и macOS/pwsh)

И двата скрипта:
- Дърпат dataset-links.csv от официалния URL
- Отсяват само записите за София (с пространствено пресичане)
- Обновяват input.txt
- Теглят всички файлове в IN/
- input.txt се обновява само с успешно изтеглените файлове

## Файлове
- `create_bulgaria_buildings_table.sql` – DDL за създаване на таблицата и индекса.
- `adm_rayoni_dump.sql` – SQL dump с административните райони.
- `import_sofia_buildings.py` – Основната програма за наливане на данните в базата.
- `input.txt` – Списък с източници на GeoJSONL файлове.
- `IN/` – Папка, в която се поставят изтеглените .gz файлове с геометрични данни за сгради.
- `download_bulgaria_buildings.py` – Python скрипт за автоматично изтегляне на данните.
- `download_bulgaria_buildings.ps1` – PowerShell скрипт за автоматично изтегляне на данните.

## Изисквания
- PostgreSQL с PostGIS (и настроен за връзка към него .env файл)
- Python 3.11+ с библиотеки: psycopg2, gzip, shapely, python-dotenv, requests
- (по избор) PowerShell (Windows/macOS) за .ps1 скрипта

## Изпълнение
1. Създайте таблицата с `create_bulgaria_buildings_table.sql`.
2. Възстановете архива на административните райони с помощта на `adm_rayoni_dump.sql`.
3. Използвайте един от скриптовете за изтегляне, за да попълните IN/ с .gz файловете.
4. Настройте .env файл с достъп до базата данни. В случая го търси в горната спрямо проекта папка.
5. Стартирайте `import_sofia_buildings.py`.

## Резултат

В базата данни следва да се появи има таблица с всички сгради, които попадат в административните граници на София, подходяща за пространствени анализи и визуализация.
